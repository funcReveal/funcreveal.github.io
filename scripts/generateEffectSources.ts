// scripts/generateEffectSources.ts
// -----------------------------------------------------
// å°‡æŒ‡å®šè³‡æ–™å¤¾ä¸­çš„ *.tsx èˆ‡ *.module.css è½‰æˆ effectSources ç‰©ä»¶
//
// ä½¿ç”¨ï¼šnpx ts-node scripts/generateEffectSources.ts <componentsDir> <outFile>
//
// ä¾è³´ï¼šnpm i -D ts-node typescript fast-glob
// -----------------------------------------------------

import fs from "fs";
import path from "path";
import fg from "fast-glob";

// --------------------------------- å·¥å…·å‡½å¼
/** æŠŠå­—ä¸²å®‰å…¨åœ°æ”¾é€² JS template literal (`â€¦`) */
function escapeForTemplateLiteral(str: string) {
  return str
    .replace(/\\/g, "\\\\") // å…ˆè·³è„« backslash
    .replace(/`/g, "\\`") // è·³è„«åå¼•è™Ÿ
    .replace(/\$\{/g, "\\${"); // é¿å…ææ—©çµæŸ template
}

/** å–å°æ‡‰ CSS è·¯å¾‘ï¼ˆå„ªå…ˆ .module.cssï¼Œå…¶æ¬¡ .cssï¼‰ */
function findCss(file: string) {
  const dir = path.dirname(file);
  const baseName = path.basename(file, ".tsx");
  const cssFile = path.join(dir, `${baseName}.module.css`);
  return fs.existsSync(cssFile) ? cssFile : null;
}

// --------------------------------- ä¸»æµç¨‹
async function main() {
  const [componentsDir, outFile] = process.argv.slice(2);

  if (!componentsDir || !outFile) {
    console.error(
      "âŒ  ç”¨æ³•ï¼šts-node generateEffectSources.ts <componentsDir> <outFile>"
    );
    process.exit(1);
  }

  // 1. æ‰¾åˆ°æ‰€æœ‰ TSX
  const tsxFiles = await fg(["**/*.tsx"], {
    cwd: componentsDir,
    absolute: true,
  });

  function toKebabCase(input: string) {
    return input.replace(/([a-z0-9])([A-Z])/g, "$1-$2").toLowerCase();
  }

  const sources: string[] = [];

  for (const tsxPath of tsxFiles) {
    const tsxCode = fs.readFileSync(tsxPath, "utf8");
    const cssPath = findCss(tsxPath);

    const cssCode = cssPath ? fs.readFileSync(cssPath, "utf8") : "";
    const pascalName = path.basename(tsxPath, ".tsx"); // e.g. GlowButton
    const kebabKey = toKebabCase(pascalName); // e.g. glow-button

    const tsxName = path.basename(tsxPath); // GlowButton.tsx
    const cssName = cssPath ? path.basename(cssPath) : "";

    const githubUrl = `https://github.com/funcReveal/effects-gallery/tree/main/js-css-effects/${kebabKey}`;

    sources.push(`
    '${kebabKey}': {
      tsxCode: \`${escapeForTemplateLiteral(tsxCode)}\`,
      cssCode: \`${escapeForTemplateLiteral(cssCode)}\`,
      githubUrl: '${githubUrl}',
      TSXName: '${tsxName}',
      CSSName: '${cssName}',
    }`);
  }

  // 2. çµ„åˆæˆå®Œæ•´æª”æ¡ˆå…§å®¹
  const fileContent = `/**
 * ğŸš€  Autoâ€‘generated by generateEffectSources.ts
 * åˆ¥æ‰‹å‹•ä¿®æ”¹ï¼Œæ”¹äº†ä¹Ÿæœƒåœ¨ä¸‹æ¬¡åŸ·è¡Œæ™‚è¢«è¦†è“‹ï¼
 */

export interface EffectSource {
  tsxCode: string;
  cssCode: string;
  githubUrl: string;
  TSXName: string;
  CSSName: string;
}

export const effectSources: Record<string, EffectSource> = {${sources.join(",")}
};
`;

  // 3. è¼¸å‡º
  fs.writeFileSync(outFile, fileContent.trim() + "\n", "utf8");
  console.log(`âœ…  å·²ç”¢ç”Ÿ ${outFile}ï¼ˆå…± ${sources.length} å€‹å…ƒä»¶ï¼‰`);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});
